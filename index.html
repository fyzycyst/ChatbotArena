<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chatbot Arena</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chat-bubble {
            max-width: 90%;
            word-wrap: break-word;
        }
        .chat-bubble.bot-a {
            background-color: #1e3a8a; /* Darker Blue */
            align-self: flex-start;
        }
        .chat-bubble.bot-b {
            background-color: #166534; /* Darker Green */
            align-self: flex-start;
        }
        /* Scrollbar styling */
        .chat-log::-webkit-scrollbar {
            width: 8px;
        }
        .chat-log::-webkit-scrollbar-track {
            background: #1f2937;
        }
        .chat-log::-webkit-scrollbar-thumb {
            background-color: #4b5563;
            border-radius: 10px;
            border: 2px solid #1f2937;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23d1d5db%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right .7rem center;
            background-size: .65em auto;
            padding-right: 2.5rem;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col min-h-screen">

    <header class="bg-gray-800 p-4 shadow-md sticky top-0 z-10">
        <h1 class="text-2xl font-bold text-center text-blue-300">AI Chatbot Arena</h1>
        <p class="text-center text-gray-400 mt-1">Let the models discuss a topic.</p>
    </header>

    <main class="flex-grow container mx-auto p-4 md:p-6">
        <!-- Settings Section -->
        <div id="settings-panel" class="bg-gray-800 p-6 rounded-lg shadow-xl mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Bot & Turn Configuration -->
                <div class="flex flex-col">
                    <h2 class="text-xl font-semibold mb-4 text-gray-200 border-b border-gray-600 pb-2">Configuration</h2>
                    <div class="flex flex-col justify-between flex-grow">
                        <!-- Bot A -->
                        <div class="flex items-center space-x-4">
                            <label for="bot-a-select" class="w-32 text-sm font-medium text-gray-300">Bot A</label>
                            <select id="bot-a-select" class="block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <!-- Options will be dynamically populated -->
                            </select>
                        </div>
                        <!-- Bot B -->
                        <div class="flex items-center space-x-4">
                            <label for="bot-b-select" class="w-32 text-sm font-medium text-gray-300">Bot B</label>
                            <select id="bot-b-select" class="block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <!-- Options will be dynamically populated -->
                            </select>
                        </div>
                        <!-- Max Turns -->
                        <div class="flex items-center space-x-4">
                            <label for="max-turns" class="w-32 text-sm font-medium text-gray-300">Max Turns (per bot)</label>
                            <input type="number" id="max-turns" value="5" min="1" max="20" class="block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                </div>
                <!-- Prompt -->
                <div>
                    <h2 class="text-xl font-semibold mb-4 text-gray-200 border-b border-gray-600 pb-2">Discussion Topic</h2>
                    <div>
                        <label for="initial-prompt" class="block text-sm font-medium text-gray-300 mb-1">Initial Topic / Prompt</label>
                        <textarea id="initial-prompt" rows="3" class="w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Discuss the pros and cons of decentralized finance."></textarea>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-2">
                        <div>
                            <label for="bot-a-instructions" class="block text-sm font-medium text-gray-300 mb-1">Bot A Instructions (Optional)</label>
                            <textarea id="bot-a-instructions" rows="2" class="w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., You are a skeptical scientist..."></textarea>
                        </div>
                        <div>
                            <label for="bot-b-instructions" class="block text-sm font-medium text-gray-300 mb-1">Bot B Instructions (Optional)</label>
                            <textarea id="bot-b-instructions" rows="2" class="w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., You are an optimistic futurist..."></textarea>
                        </div>
                    </div>
                    <div class="mt-3">
                        <label for="file-input" class="block text-sm font-medium text-gray-300 mb-1">Attach Files (optional)</label>
                        <input type="file" id="file-input" multiple class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-500 file:text-white hover:file:bg-blue-600"/>
                    </div>
                </div>
            </div>
            <!-- Action Buttons -->
            <div class="mt-6 flex items-center justify-center space-x-4">
                <button id="start-btn" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-md transition-all duration-200">Start Discussion</button>
                <button id="stop-btn" class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg shadow-md transition-all duration-200" disabled>Stop</button>
                <button id="reset-btn" class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-bold rounded-lg shadow-md transition-all duration-200">Reset</button>
            </div>
             <div id="error-box" class="mt-4 text-red-400 text-center font-medium"></div>
             <div id="status-indicator" class="mt-4 text-center font-medium"></div>
        </div>

        <!-- Discussion Arena -->
        <div id="discussion-arena" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Bot A Pane -->
            <div class="bg-gray-800 rounded-lg shadow-xl flex flex-col h-[60vh]">
                <h3 id="bot-a-title" class="text-lg font-semibold p-4 bg-blue-900/50 rounded-t-lg"></h3>
                <div id="bot-a-log" class="flex-grow p-4 overflow-y-auto chat-log flex flex-col space-y-4"></div>
                <div id="bot-a-loader" class="p-4 hidden justify-center items-center"><div class="loader"></div></div>
            </div>
            <!-- Bot B Pane -->
            <div class="bg-gray-800 rounded-lg shadow-xl flex flex-col h-[60vh]">
                <h3 id="bot-b-title" class="text-lg font-semibold p-4 bg-green-900/50 rounded-t-lg"></h3>
                <div id="bot-b-log" class="flex-grow p-4 overflow-y-auto chat-log flex flex-col space-y-4"></div>
                 <div id="bot-b-loader" class="p-4 hidden justify-center items-center"><div class="loader"></div></div>
            </div>
        </div>
    </main>

    <footer class="text-center p-4 border-t border-gray-700">
        <p class="text-gray-400 text-sm">
            Enjoying this tool?
            <a href="https://coff.ee/themodeleer" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:text-blue-300 transition-colors inline-flex items-center">
                <svg class="w-5 h-5 mr-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v1.135A4.002 4.002 0 0115 9.135V12a1 1 0 11-2 0V9.135a2.002 2.002 0 00-1.5-1.932V15a1 1 0 11-2 0V7.203a2.002 2.002 0 00-1.5 1.932V12a1 1 0 11-2 0V9.135A4.002 4.002 0 019 5.135V4a1 1 0 011-1zM5.93 13.07a1 1 0 01.94-1.48 5.99 5.99 0 017.13 0 1 1 0 11-1.28 1.54 3.99 3.99 0 00-4.57 0 1 1 0 01-1.22-1.56z" clip-rule="evenodd" />
                    <path d="M3 13a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" />
                </svg>
                Buy me a coffee
            </a>
        </p>
    </footer>

    <script src="config.js"></script>
    <script type="module">
        console.log("Script execution started.");

        function initializeApp() {
            console.log("initializeApp function called.");

            // --- Configuration is loaded from config.js ---


            // --- DOM Elements ---
            console.log("Defining DOM elements...");
            const botASelect = document.getElementById('bot-a-select');
            const botBSelect = document.getElementById('bot-b-select');
            const botATitle = document.getElementById('bot-a-title');
            const botBTitle = document.getElementById('bot-b-title');
            const botALog = document.getElementById('bot-a-log');
            const botBLog = document.getElementById('bot-b-log');
            const botALoader = document.getElementById('bot-a-loader');
            const botBLoader = document.getElementById('bot-b-loader');
            
            const initialPromptInput = document.getElementById('initial-prompt');
            const fileInput = document.getElementById('file-input');
            const maxTurnsInput = document.getElementById('max-turns');
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');
            const resetBtn = document.getElementById('reset-btn');
            const errorBox = document.getElementById('error-box');
            const statusIndicator = document.getElementById('status-indicator');
            const botAInstructionsInput = document.getElementById('bot-a-instructions');
            const botBInstructionsInput = document.getElementById('bot-b-instructions');

            console.log("botASelect element:", botASelect);
            console.log("botBSelect element:", botBSelect);

            if (!botASelect || !botBSelect) {
                console.error("ERROR: Could not find the bot select dropdowns in the DOM!");
                return; // Stop execution if elements aren't found
            }

            // --- State ---
            let isRunning = false;
            let discussionCompleted = false;
            let conversationHistory = [];
            let currentTurn = 0;

            /**
             * Calls the Gemini API.
             */
            async function callGeminiApi(config, history, instructions) {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${config.model}:generateContent?key=${config.apiKey}`;
                
                let geminiHistory = [...history];
                if (instructions) {
                    geminiHistory.unshift({ role: 'user', parts: [{ text: `Your instructions are: "${instructions}"` }]});
                }

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: geminiHistory,
                        generationConfig: { temperature: 0.7, maxOutputTokens: 2048 }
                    }),
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Gemini API Error: ${errorData.error.message}`);
                }
                const data = await response.json();
                if (!data.candidates || !data.candidates[0].content.parts[0].text) {
                    throw new Error('Invalid response structure from Gemini API.');
                }
                return data.candidates[0].content.parts[0].text.trim();
            }

            /**
             * Calls any OpenAI-compatible API (OpenAI, xAI).
             */
            async function callOpenAICompatibleApi(config, history, instructions) {
                const systemPrompt = { role: 'system', content: instructions || `You are a helpful AI assistant in a debate with another AI. Respond to the last statement from your opponent.` };
                const openAiHistory = [
                    systemPrompt,
                    ...history.slice(1).map(msg => ({
                        role: msg.role === 'model' ? 'user' : 'assistant',
                        content: msg.parts[0].text
                    }))
                ];
                const response = await fetch(config.url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${config.apiKey}`,
                    },
                    body: JSON.stringify({
                        model: config.model,
                        messages: openAiHistory,
                        temperature: 0.7,
                        max_tokens: 2048,
                    }),
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error (${config.displayName}): ${errorData.error.message}`);
                }
                const data = await response.json();
                if (!data.choices || !data.choices[0].message.content) {
                    throw new Error(`Invalid response structure from ${config.displayName} API.`);
                }
                return data.choices[0].message.content.trim();
            }

            /**
             * Calls the Anthropic API.
             */
            async function callAnthropicApi(config, history, instructions) {
                const systemPrompt = instructions || `You are a helpful AI assistant, ${config.displayName}, in a debate with another AI. Respond to the last statement from your opponent. The initial topic was: "${initialPromptInput.value.trim()}"`;
                const anthropicHistory = history.map(msg => ({
                    role: msg.role === 'model' ? 'assistant' : 'user',
                    content: msg.parts[0].text
                }));

                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': config.apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: config.model,
                        system: systemPrompt,
                        messages: anthropicHistory,
                        max_tokens: 2048,
                        temperature: 0.7
                    })
                });
                 if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Anthropic API Error: ${errorData.error.message}`);
                }
                const data = await response.json();
                if (!data.content || !data.content[0].text) {
                    throw new Error('Invalid response structure from Anthropic API.');
                }
                return data.content[0].text.trim();
            }


            const apiImplementations = {
                gemini: callGeminiApi,
                openai_compatible: callOpenAICompatibleApi,
                anthropic: callAnthropicApi
            };

            // --- Functions ---
            function displayMessage(logElement, message, type) {
                const bubble = document.createElement('div');
                bubble.className = `p-3 rounded-lg chat-bubble ${type}`;
                bubble.textContent = message;
                logElement.appendChild(bubble);
                logElement.scrollTop = logElement.scrollHeight;
            }

            function toggleLoader(loaderElement, show) {
                loaderElement.style.display = show ? 'flex' : 'none';
            }

            function displayError(message) {
                errorBox.textContent = message;
                console.error(message);
            }

            function clearError() {
                errorBox.textContent = '';
            }
            
            function setUiState(running) {
                isRunning = running;
                startBtn.disabled = running;
                stopBtn.disabled = !running;
                resetBtn.disabled = running;
                botASelect.disabled = running;
                botBSelect.disabled = running;
                initialPromptInput.disabled = running;
                fileInput.disabled = running;
                maxTurnsInput.disabled = running;
                botAInstructionsInput.disabled = running;
                botBInstructionsInput.disabled = running;

                if (running) {
                    statusIndicator.textContent = 'Working...';
                    statusIndicator.className = 'mt-4 text-yellow-400 text-center font-medium';
                } else if (discussionCompleted) {
                    statusIndicator.textContent = 'Complete!';
                    statusIndicator.className = 'mt-4 text-green-400 text-center font-medium';
                } else {
                    statusIndicator.textContent = '';
                }
            }

            function getBotPrompt(botConfig, opponentConfig, initialTopic, instructions) {
                let prompt = `You are a helpful AI assistant, ${botConfig.displayName}, in a debate with another AI, ${opponentConfig.displayName}. Please provide a thoughtful and well-reasoned opening statement on the following topic. Be concise. Topic: "${initialTopic}"`;
                if (instructions) {
                    prompt = `Your instructions are: "${instructions}".

${prompt}`;
                }
                return prompt;
            }

            /**
             * Main orchestrator for the discussion.
             */
            async function startDiscussion() {
                clearError();
                discussionCompleted = false;

                const botAId = botASelect.value;
                const botBId = botBSelect.value;
                let initialPrompt = initialPromptInput.value.trim();
                const maxTurns = parseInt(maxTurnsInput.value, 10);
                const files = fileInput.files;

                if (botAId === botBId) {
                    displayError('Please select two different bots for the discussion.');
                    return;
                }

                // Read file contents and prepend to the prompt
                if (files.length > 0) {
                    let fileContents = "";
                    for (const file of files) {
                        fileContents += await file.text();
                        fileContents += "\n\n";
                    }
                    initialPrompt = `Attached File(s) Content:\n\n${fileContents}--- End of File(s) Content ---\n\nInitial Prompt:\n\n${initialPrompt}`;
                }

                const botAConfig = { ...BOT_CONFIG[botAId], apiKey: API_KEYS[BOT_CONFIG[botAId].keyName] };
                const botBConfig = { ...BOT_CONFIG[botBId], apiKey: API_KEYS[BOT_CONFIG[botBId].keyName] };

                if (!botAConfig.apiKey || botAConfig.apiKey.includes("PASTE") || !botBConfig.apiKey || botBConfig.apiKey.includes("PASTE")) {
                    displayError('Please paste your API keys into the script\'s API_KEYS section.');
                    return;
                }
                 if (!initialPrompt) {
                    displayError('Please provide an initial prompt.');
                    return;
                }

                setUiState(true);
                currentTurn = 0;

                const botAInstructions = botAInstructionsInput.value.trim();
                const botBInstructions = botBInstructionsInput.value.trim();

                const botAInitialPrompt = getBotPrompt(botAConfig, botBConfig, initialPrompt, botAInstructions);
                conversationHistory = [{ role: 'user', parts: [{ text: botAInitialPrompt }] }];
                
                const botAFunc = apiImplementations[botAConfig.api];
                const botBFunc = apiImplementations[botBConfig.api];

                while (isRunning && currentTurn < maxTurns) {
                    try {
                        // --- Bot A's Turn ---
                        if (!isRunning) break;
                        toggleLoader(botALoader, true);
                        const botAResponse = await botAFunc(botAConfig, conversationHistory, botAInstructions);
                        toggleLoader(botALoader, false);
                        displayMessage(botALog, botAResponse, 'bot-a');
                        conversationHistory.push({ role: 'model', parts: [{ text: botAResponse }] });
                        
                        // --- Bot B's Turn ---
                        if (!isRunning) break;
                        toggleLoader(botBLoader, true);
                        const botBResponse = await botBFunc(botBConfig, conversationHistory, botBInstructions);
                        toggleLoader(botBLoader, false);
                        displayMessage(botBLog, botBResponse, 'bot-b');
                        conversationHistory.push({ role: 'user', parts: [{ text: botBResponse }] });

                        currentTurn++;

                    } catch (error) {
                        displayError(error.message);
                        setUiState(false);
                        break;
                    }
                }
                
                if (isRunning) {
                    discussionCompleted = true;
                    setUiState(false);
                }
            }
            
            function stopDiscussion() {
                setUiState(false);
                toggleLoader(botALoader, false);
                toggleLoader(botBLoader, false);
            }

            function resetApplication() {
                stopDiscussion();
                clearError();
                discussionCompleted = false;
                statusIndicator.textContent = '';
                botALog.innerHTML = '';
                botBLog.innerHTML = '';
                initialPromptInput.value = '';
                botAInstructionsInput.value = '';
                botBInstructionsInput.value = '';
                conversationHistory = [];
                currentTurn = 0;
                console.log("Application reset.");
            }

            function updateTitles() {
                const botAName = BOT_CONFIG[botASelect.value]?.displayName || 'Bot A';
                const botBName = BOT_CONFIG[botBSelect.value]?.displayName || 'Bot B';
                botATitle.innerHTML = `<span class="text-blue-300">Bot A: ${botAName}</span>`;
                botBTitle.innerHTML = `<span class="text-green-300">Bot B: ${botBName}</span>`;
            }

            function populateBotSelectors() {
                console.log("populateBotSelectors function called.");
                console.log("Inside populateBotSelectors, botASelect is:", botASelect);
                const botIds = Object.keys(BOT_CONFIG);
                botASelect.innerHTML = '';
                botBSelect.innerHTML = '';

                botIds.forEach((id) => {
                    const optionA = document.createElement('option');
                    optionA.value = id;
                    optionA.textContent = BOT_CONFIG[id].displayName;
                    botASelect.appendChild(optionA);

                    const optionB = document.createElement('option');
                    optionB.value = id;
                    optionB.textContent = BOT_CONFIG[id].displayName;
                    botBSelect.appendChild(optionB);
                });
                
                // Set default selections to be different
                if (botIds.length > 1) {
                    botASelect.value = botIds[0];
                    botBSelect.value = botIds[1];
                }
                updateTitles();
            }

            // --- Event Listeners ---
            console.log("Adding event listeners.");
            startBtn.addEventListener('click', startDiscussion);
            stopBtn.addEventListener('click', stopDiscussion);
            resetBtn.addEventListener('click', resetApplication);
            botASelect.addEventListener('change', updateTitles);
            botBSelect.addEventListener('change', updateTitles);

            // --- Initial Setup ---
            console.log("Running initial setup.");
            populateBotSelectors();
        }

        // The main entry point
        if (document.readyState === 'loading') {
            // Loading hasn't finished yet
            console.log("DOM is loading, adding DOMContentLoaded listener.");
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            // `DOMContentLoaded` has already fired
            console.log("DOM is already loaded, calling initializeApp directly.");
            initializeApp();
        }
    </script>

</body>
</html>